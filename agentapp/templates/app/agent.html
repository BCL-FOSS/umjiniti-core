{% extends 'app/base.html' %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-header pb-0">
          <h6>umjiniti AI Network Admin Assistant</h6>
        </div>
        <div class="card-body px-0 pt-0 pb-2">
          <div class="row">
            <!-- Left: MCP selection -->
            <div class="col-md-6 col-lg-5 col-xl-4 mb-4 mb-md-0">
              <div class="p-3">
                <!-- Search -->
                <div class="input-group rounded mb-3">
                  <input type="search" class="form-control rounded" placeholder="Search">
                  <span class="input-group-text border-0"><i class="fas fa-search"></i></span>
                </div>

                <!-- Dropdown -->
                <div class="mb-3">
                  <label for="mcp-dropdown" class="form-label">Select MCP Option:</label>
                  <select id="mcp-dropdown" class="form-select">
                    {% for opt in options %}
                      <option value="{{ opt }}">{{ opt }}</option>
                    {% endfor %}
                  </select>
                </div>

                <!-- List -->
                <div style="position: relative; height: 400px; overflow-y:auto;" id="mcp-list-container">
                  <ul class="list-unstyled mb-0" id="mcp-list">
                    {% for opt in options %}
                      <li class="p-2 border-bottom" data-value="{{ opt }}">
                        <a href="#!" class="d-flex justify-content-between">
                          <div class="d-flex flex-row">
                            <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava1-bg.webp"
                              alt="avatar" class="d-flex align-self-center me-3" width="60">
                            <div class="pt-1">
                              <p class="fw-bold mb-0">{{ opt }}</p>
                              <p class="small text-muted">Description for {{ opt }}</p>
                            </div>
                          </div>
                          <div class="pt-1"><p class="small text-muted mb-1">Now</p></div>
                        </a>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              </div>
            </div>

            <!-- Right: Chat (multiple windows) -->
            <div class="col-md-6 col-lg-7 col-xl-8">
              <div id="chat-container" style="height: 500px; overflow-y: auto;" class="border p-3 mb-3">
                {% for opt in options %}
                  <div class="chat-window" id="chat-{{ opt }}" style="display: none; height:100%; overflow-y:auto;"></div>
                {% endfor %}
              </div>
              <div class="input-group">
                <input type="text" id="chat-input" class="form-control" placeholder="Type a message...">
                <button id="chat-send" class="btn btn-primary">Send</button>
              </div>
            </div>
          </div> 
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .chat-message { margin-bottom: 8px; }
  .chat-message.user { text-align: right; }
  .chat-message.agent { text-align: left; }
</style>

<script type="text/javascript">
  const chatInput = document.getElementById("chat-input");
  const chatSend = document.getElementById("chat-send");
  const mcpDropdown = document.getElementById("mcp-dropdown");
  const mcpList = document.getElementById("mcp-list");

  if (!chatInput || !chatSend) {
    // Not an agent page or missing elements
    console.debug("Chat UI elements missing — agent chat script not initialized.");
    return;
  }

  // Utility functions for appending messages
  function appendMessage(chatWin, from, text) {
    if (!chatWin) return;
    chatWin.innerHTML += `<p><strong>${from}</strong></p>`;
    const lines = String(text).split(/\r?\n/);
    for (const line of lines) {
      if (line.trim() !== "") {
        chatWin.innerHTML += `<p>${line}</p>`;
      } else {
        chatWin.innerHTML += `<br>`;
      }
    }
    chatWin.scrollTop = chatWin.scrollHeight;
  }

  function appendUserMessage(chatWin, from, text) {
    if (!chatWin) return;
    chatWin.innerHTML += `<p><strong>${from}</strong> ${text}</p>`;
    chatWin.scrollTop = chatWin.scrollHeight;
  }

  // Selected MCP (starts from dropdown if present)
  let selectedValue = mcpDropdown ? mcpDropdown.value : null;

  // When a ws-message event arrives, process chat messages destined for this user
  function onWsMessage(evt) {
    const data = evt.detail;
    try {
      if (data && data.msg && data.from) {
        // optionally filter by user id
        if (data.usr_id && data.usr_id !== "{{ cur_usr }}") {
          // Not for this user
          return;
        }
        const chatWin = document.getElementById(`chat-${data.url}`);
        if (chatWin) appendMessage(chatWin, data.from, data.msg);
      }
    } catch (err) {
      console.error("Agent ws-message handler error:", err);
    }
  }

  // If wsMon is already present and open, we can attach the message listener.
  // Otherwise listen for 'ws-open' and then attach.
  function attachWsListeners() {
    if (typeof window === 'undefined') return;
    if (!window.wsMon) {
      // Still no wsMon; wait for ws-open
      window.addEventListener('ws-open', function onopenOnce() {
        window.removeEventListener('ws-open', onopenOnce);
        window.addEventListener('ws-message', onWsMessage);
      });
    } else {
      // wsMon exists: attach listener for messages (we rely on base to dispatch 'ws-message')
      window.addEventListener('ws-message', onWsMessage);
    }
  }

  attachWsListeners();

  // Send message via window.wsMon (if open)
  function sendMessage() {
    if (!selectedValue || !chatInput.value.trim()) {
      alert('Make a probe selection or enter a chat query.');
      return;
    }
    const msg = chatInput.value.trim();
    chatInput.value = "";

    const payload = {
      act: "llm",
      url: selectedValue,
      usr: window.currentUser || "{{ user }}",
      from: "user",
      msg: msg,
      usr_id: "{{ cur_usr }}"
    };

    if (window.wsMon && window.wsMon.readyState === WebSocket.OPEN) {
      try {
        window.wsMon.send(JSON.stringify(payload));
      } catch (e) {
        console.error("Failed to send message via WebSocket:", e);
      }
    } else {
      console.warn("WebSocket not open — cannot send chat message now.");
    }

    const chatWin = document.getElementById(`chat-${selectedValue}`);
    if (chatWin) appendUserMessage(chatWin, "user", msg);
  }

  chatSend.addEventListener("click", sendMessage);
  chatInput.addEventListener("keypress", function (e) {
    if (e.key === "Enter") sendMessage();
  });

  if (mcpDropdown) {
    mcpDropdown.addEventListener("change", function (e) {
      selectedValue = e.target.value;
      showChat(selectedValue);
    });
  }

  if (mcpList && mcpList.querySelectorAll) {
    mcpList.querySelectorAll("li").forEach(li => {
      li.addEventListener("click", () => {
        selectedValue = li.dataset.value;
        if (mcpDropdown) mcpDropdown.value = selectedValue;
        showChat(selectedValue);
      });
    });
  }

  // show selected chat window
  window.showChat = function (url) {
    document.querySelectorAll(".chat-window").forEach(w => w.style.display = "none");
    const chatWin = document.getElementById(`chat-${url}`);
    if (chatWin) chatWin.style.display = "block";
  };

  // load history for chat - uses wsMon if open
  window.loadChat = function (url, user) {
    showChat(url);
    if (window.wsMon && window.wsMon.readyState === WebSocket.OPEN) {
      try {
        window.wsMon.send(JSON.stringify({ act: "hist", url: url, usr: user }));
      } catch (e) {
        console.error("Failed to request history via WebSocket:", e);
      }
    } else {
      console.warn("WebSocket not open; cannot request chat history now.");
    }
  };
</script>

{% endblock %}
