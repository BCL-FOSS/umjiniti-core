{% extends 'app/base.html' %}

{% block content %}
<style>
  .modal {
    z-index: 2050 !important;
  }
</style>
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-header pb-0">
          <h6>All Alerts</h6>
        </div>
        <div class="card-body px-0 pt-0 pb-2">
          <div class="table-responsive">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Type</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Name</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Site</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Timestamp</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Acknowledged</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Resolved</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for alert in alerts.values() %}
                <tr>
                  <td>
                    <div class="d-flex px-2">
                      <div>
                        <img src="{{ url_for('static', filename='img/bcl/'+alert.alert_type+'.svg') }}" class="avatar avatar-sm rounded-circle me-2"/>
                      </div>
                      <div class="my-auto">
                        <h6 class="mb-0 text-xs">{{ alert.alert_type }}</h6>
                      </div>
                    </div>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ alert.name }}</p>
                  </td>
                  <td>
                    <span class="badge badge-dot me-4">
                      <i class="bg-info"></i>
                      <span class="text-dark text-xs">{{ alert.site }}</span>
                    </span>
                  </td>
                  <td class="align-middle text-center">
                    <div class="d-flex align-items-center">
                      <span class="me-2 text-xs">{{ alert.timestamp }}</span>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex px-2">
                      <div>
                        <img src="{{ url_for('static', filename='img/bcl/'+alert.ack+'.svg') }}" class="avatar avatar-sm rounded-circle me-2"/>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex px-2">
                      <div>
                        <img src="{{ url_for('static', filename='img/bcl/'+alert.rslv+'.svg') }}" class="avatar avatar-sm rounded-circle me-2"/>
                      </div>
                    </div>
                  </td>

                  <td class="align-middle">
                    <div class="input-group mb-3">
                      <button type="button" class="btn btn-sm btn-info ms-2 alert-details-btn"
                          data-name="{{ alert.name|e }}"
                          data-msg="{{ alert.msg|e }}"
                          data-site="{{ alert.site|e }}"
                          data-prb_id="{{ alert.prb_id|e }}"
                          data-timestamp="{{ alert.timestamp|e }}"
                          data-alert_type="{{ alert.alert_type|e }}"
                          data-id="{{ alert.id }}">
                        View Details
                      </button>
                      <button type="button" class="btn btn-sm btn-info ms-2 alert-acknowledge-btn"
                          data-name="{{ alert.name|e }}"
                          data-msg="{{ alert.msg|e }}"
                          data-site="{{ alert.site|e }}"
                          data-prb_id="{{ alert.prb_id|e }}"
                          data-timestamp="{{ alert.timestamp|e }}"
                          data-alert_type="{{ alert.alert_type|e }}"
                          data-id="{{ alert.id }}">
                        Acknowledge
                      </button>
                      <button type="button" class="btn btn-sm btn-info ms-2 alert-resolve-btn"
                          data-name="{{ alert.name|e }}"
                          data-msg="{{ alert.msg|e }}"
                          data-site="{{ alert.site|e }}"
                          data-prb_id="{{ alert.prb_id|e }}"
                          data-timestamp="{{ alert.timestamp|e }}"
                          data-alert_type="{{ alert.alert_type|e }}"
                          data-id="{{ alert.id }}">
                        Resolve
                      </button>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="alertViewModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="alertViewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="alertViewModalLabel">Alert Details</h5>
       
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="alert-msg"></p>

        <div class="terminal-container mb-4">
          <div class="window-bar">
            <div class="window-buttons">
              <div class="window-button close"></div>
              <div class="window-button minimize"></div>
              <div class="window-button maximize"></div>
            </div>
          </div>
          <div class="terminal" id="terminal-output">
            <p class="form-text"><code id="alert-msg"></code><br></p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="alertAckModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="alertAckModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="alertAckModalLabel">Alert Acknowledge</h5>
        <div id="alert-ack-id"></div>
       
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="alert-ack-msg"></p>
      
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger" id="alert-ack-init">
          <span class="spinner-grow spinner-grow-sm d-none" role="status" aria-hidden="true"></span>
          <span class="alert-ack-button-text">Acknowledge</span>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="alertRslvModal"  data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="alertRslvModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="alertRslvModalLabel">Alert Resolve</h5>
        <div id="alert-rslv-id"></div>
       
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="alert-rslv-msg"></p>
      
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger" id="alert-rslv-init">
          <span class="spinner-grow spinner-grow-sm d-none" role="status" aria-hidden="true"></span>
          <span class="alert-rslv-button-text">Resolve</span>
        </button>
      </div>
    </div>
  </div>
</div>


<script type="text/javascript">
document.addEventListener("DOMContentLoaded", () => {
  const table = document.querySelector("#probeTable");
  const rows = table.querySelectorAll("tbody tr");
  const mntrURL = "{{ mntr_url }}";
  const notificationModal = new bootstrap.Modal(document.getElementById('notificationModal'), {});

  // Handle row selection
  rows.forEach(row => {
    row.addEventListener("click", () => {
      rows.forEach(r => {
        r.classList.remove("selected");
        r.style.backgroundColor = "";
      });
      row.classList.add("selected");
      row.style.backgroundColor = "lightcoral";
    });
  });

  const alertViewButtons = document.querySelectorAll(".alert-details-btn");
  const alertAckButtons = document.querySelectorAll(".alert-acknowledge-btn");
  const alertRslvButtons = document.querySelectorAll(".alert-resolve-btn");

  const alertAckInitButton = document.getElementById("alert-ack-init");
  const alertRslvInitButton = document.getElementById("alert-rslv-init");

  const alertViewModal = new bootstrap.Modal(document.getElementById('alertViewModal'));
  const alertAckModal = new bootstrap.Modal(document.getElementById('alertAckModal'));
  const alertRslvModal = new bootstrap.Modal(document.getElementById('alertRslvModal'));

  // View Details button handler
  alertViewButtons.forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation(); // prevent row click selection (if undesired)
      const name = btn.dataset.name || '';
      const msg = btn.dataset.msg || '';
      const site = btn.dataset.site || '';
      const prb_id = btn.dataset.prb_id || '';
      const timestamp = btn.dataset.timestamp || '';
      const alert_type = btn.dataset.alert_type || '';
      const id = btn.dataset.id || '';
      // Fill modal fields
      document.getElementById('alertViewModalLabel').textContent = `Alert Details - ${name} ${alert_type}`;
      document.getElementById('alert-msg').textContent = msg;
      if (alertViewModal) {
        alertViewModal.show();
      } else {
        console.warn("Bootstrap Modal not available - cannot show alert view modal.");
      }
    });
  });

  // Acknowledge button handler
  alertAckButtons.forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation(); // prevent row click selection (if undesired)
      const name = btn.dataset.name || '';
      const msg = btn.dataset.msg || '';
      const site = btn.dataset.site || '';
      const prb_id = btn.dataset.prb_id || '';
      const timestamp = btn.dataset.timestamp || '';
      const alert_type = btn.dataset.alert_type || '';
      const id = btn.dataset.id || '';
      // Fill modal fields
      document.getElementById('alertAckModalLabel').textContent = `Acknowledge Alert - ${name} ${alert_type}`;
      document.getElementById('alert-ack-msg').textContent = `Are you sure you want to acknowledge the alert: ${msg}`;
      document.getElementById('alert-ack-init').dataset.id = id;
      if (alertAckModal) {
        alertAckModal.show();
      } else {
        console.warn("Bootstrap Modal not available - cannot show alert acknowledge modal.");
      }
    });
  });

  // Resolve button handler
  alertRslvButtons.forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation(); // prevent row click selection (if undesired)
      const name = btn.dataset.name || '';
      const msg = btn.dataset.msg || '';
      const site = btn.dataset.site || '';
      const prb_id = btn.dataset.prb_id || '';
      const timestamp = btn.dataset.timestamp || '';
      const alert_type = btn.dataset.alert_type || '';
      const id = btn.dataset.id || '';
      // Fill modal fields
      document.getElementById('alertRslvModalLabel').textContent = `Resolve Alert - ${name} ${alert_type}`;
      document.getElementById('alert-rslv-msg').textContent = `Are you sure you want to resolve the alert: ${msg}`;
      document.getElementById('alert-rslv-init').dataset.id = id;
      if (alertRslvModal) {
        alertRslvModal.show();
      } else {
        console.warn("Bootstrap Modal not available - cannot show alert resolve modal.");
      }
    });
  });

  alertAckInitButton.addEventListener("click", async function() {
    const spinner = this.querySelector(".spinner-grow");
    const buttonText = this.querySelector(".alert-ack-button-text");
    
    spinner.classList.remove('d-none');
    spinner.classList.add('d-inline-block');
    buttonText.textContent = "Acknowledging Alert...";
    this.disabled = true;

    const endpoint = `https://${mntrURL}/v1/api/core/user/alerts?usr={{ cur_usr }}`;
    const payload = { 'id': this.dataset.id,
                         'action': 'ack' };
    
    const resp = await fetch(endpoint, {method: "POST", credentials:"same-origin", headers: {"Content-Type": "application/json"}, body: JSON.stringify(payload)});
      if (resp.ok) {
        spinner.classList.remove('d-inline-block');
        spinner.classList.add('d-none');
        buttonText.textContent = "Acknowledge";
        this.disabled = false;

        document.getElementById('notificationModalLabel').textContent = 'Alert Acknowledge Success';
        document.getElementById('notif-modal-text').innerText = `The ${this.dataset.alert_type} alert has been successfully acknowledged.`;
        notificationModal.show();
      } else {
        spinner.classList.remove('d-inline-block');
        spinner.classList.add('d-none');
        buttonText.textContent = "Acknowledge";
        this.disabled = false;

        document.getElementById('notificationModalLabel').textContent = 'Alert Acknowledge Failed';
        document.getElementById('notif-modal-text').innerText = `Failed to acknowledge the ${this.dataset.alert_type} alert. Please try again.`;
        notificationModal.show();
      }
  });

  alertRslvInitButton.addEventListener("click", async function() {
    const spinner = this.querySelector(".spinner-grow");
    const buttonText = this.querySelector(".alert-rslv-button-text");
    spinner.classList.remove('d-none');
    spinner.classList.add('d-inline-block');
    buttonText.textContent = "Resolving Alert...";
    this.disabled = true;

    const endpoint = `https://${mntrURL}/v1/api/core/user/alerts?usr={{ cur_usr }}`;
    const payload = { 'id': this.dataset.id,
                         'action': 'rslv' };
    
    const resp = await fetch(endpoint, {method: "POST", credentials:"same-origin", headers: {"Content-Type": "application/json"}, body: JSON.stringify(payload)});
      if (resp.ok) {
        spinner.classList.remove('d-inline-block');
        spinner.classList.add('d-none');
        buttonText.textContent = "Resolve";
        this.disabled = false;

        document.getElementById('notificationModalLabel').textContent = 'Alert Resolve Success';
        document.getElementById('notif-modal-text').innerText = `The ${this.dataset.alert_type} alert has been successfully resolved.`;
        notificationModal.show();
        
      } else {
        spinner.classList.remove('d-inline-block');
        spinner.classList.add('d-none');
        buttonText.textContent = "Resolve";
        this.disabled = false;

        document.getElementById('notificationModalLabel').textContent = 'Alert Resolve Failed';
        document.getElementById('notif-modal-text').innerText = `Failed to resolve the ${this.dataset.alert_type} alert. Please try again.`;
        notificationModal.show();
      }
  });

});
</script>
{% endblock %}