<!DOCTYPE html>
<html lang="en" class="bg-gradient-dark">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/bcl/umjiniti.png') }}" />
    <title>
      {% block title %} {% endblock %}
    </title>
    <!--     Fonts and icons     -->
    <link href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,800" rel="stylesheet" />
    <!-- Nucleo Icons -->
    <!--<link href="https://demos.creative-tim.com/soft-ui-dashboard/assets/css/nucleo-icons.css" rel="stylesheet" />-->
    <link href="{{ url_for('static', filename='css/nucleo-icons.css') }}" rel="stylesheet" />
  
    <!--<link href="https://demos.creative-tim.com/soft-ui-dashboard/assets/css/nucleo-svg.css" rel="stylesheet" />-->
    <link href="{{ url_for('static', filename='css/nucleo-svg.css') }}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/chat.css') }}" rel="stylesheet" />
    
    <!--<script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>-->
    <script src="{{ url_for('static', filename='js/font-awesome-all.js') }}" ></script>
    <!--<script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>-->
    <script src="{{ url_for('static', filename='js/vis-network.min.js') }}" ></script>
    <!--<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>-->
    <script src="{{ url_for('static', filename='js/axios.min.js') }}" ></script>
  
    <!-- Font Awesome Icons -->
    <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
    <!-- CSS Files -->
    <!--<link id="pagestyle" href="../assets/css/soft-ui-dashboard.css?v=1.1.0" rel="stylesheet" />-->
    <link id="pagestyle" href="{{ url_for('static', filename='css/soft-ui-dashboard.min.css') }}" rel="stylesheet" />
    <!--<link href="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.css" rel="stylesheet" />-->
    <link href="{{ url_for('static', filename='css/vis-network.min.css') }}" rel="stylesheet" />
    <!-- Drawflow -->
    <!--<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow@0.0.48/dist/drawflow.min.css">-->
    <link href="{{ url_for('static', filename='css/drawflow.min.css') }}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/workflow.css') }}" rel="stylesheet" />
    
    <style>
      #network { width: 100%; height: 85vh; background: #f0f0f0; border: 1px solid #ccc; }
      body { font-family: Arial, sans-serif; }
      #controls { text-align: center; margin: 10px; }
      .alert { color: red; font-weight: bold; }

      /* Modal styles */
      .modal { display: none; position: fixed; z-index: 10; padding-top: 100px; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
      .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 50%; border-radius: 10px; }
      #modal-close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
      #modal-close:hover { color: red; }

      /* Glow animation */
      @keyframes glow {
        0% { box-shadow: 0 0 10px #00ff00; }
        50% { box-shadow: 0 0 20px #00ff00; }
        100% { box-shadow: 0 0 10px #00ff00; }
      }

      .terminal-container {
          max-width: 800px;
          margin: auto;
          border-radius: 12px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
          overflow: hidden;
      }

      .window-bar {
          background: #2f2f2f;
          height: 32px;
          display: flex;
          align-items: center;
          padding: 0 0.75rem;
      }

      .window-buttons {
          display: flex;
          gap: 0.5rem;
      }

      .window-button {
          width: 12px;
          height: 12px;
          border-radius: 50%;
      }

      .close { background: #ff5f56; }
      .minimize { background: #ffbd2e; }
      .maximize { background: #27c93f; }

      .terminal {
          background-color: #1e1e1e;
          color: #d4d4d4;
          font-family: 'Courier New', Courier, monospace;
          padding: 1rem;
          white-space: pre-wrap;
          overflow-y: auto;
          max-height: 80vh;
          font-size: 0.9rem;
      }

      /* Bell flash animation for new notifications */
      @keyframes bell-pulse {
        0% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(255,215,0,0)); }
        40% { transform: scale(1.12); filter: drop-shadow(0 0 10px rgba(255,215,0,0.9)); }
        100% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(255,215,0,0)); }
      }
      .bell-flash {
        animation: bell-pulse 0.9s ease-in-out 0s 3; /* run 3 pulses */
        color: #ffd24d !important;
        text-shadow: 0 0 8px rgba(255,215,0,0.8);
      }

      @media (max-width: 600px) {
          .terminal {
              font-size: 0.8rem;
              padding: 0.75rem;
          }

          .window-bar {
              padding: 0 0.5rem;
              height: 28px;
          }

          .window-button {
              width: 10px;
              height: 10px;
          }
      }

      /* Expand main content when sidebar is hidden */
      .main-content-expanded {
        margin-left: 0 !important;
        width: 100% !important;
      }
      
      .hide-sidebar .sidenav {
        display: none !important;
      }
  </style>
</head>

<body class="g-sidenav-show bg-gradient-dark{% if hide_sidebar %} hide-sidebar{% endif %}">
  <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3 bg-gradient-dark{% if hide_sidebar %} d-none{% endif %}" id="sidenav-main">
    <div class="sidenav-header">
      <i class="fas fa-times p-3 cursor-pointer text-secondary opacity-5 position-absolute end-0 top-0 d-none d-xl-none" aria-hidden="true" id="iconSidenav"></i>
      <a class="navbar-brand m-0" href="{{ url_for('dashboard', cmp_id=cmp_id, obsc=obsc_key) }}">
        <img src="{{ url_for('static', filename='img/bcl/umjinilogo.jpg') }}" class="navbar-brand-img h-100" alt="Consulting services logo"/>
        <span class="ms-1 font-weight-bold text-white">umjini</span>
      </a>
    </div>
    <hr class="horizontal dark mt-0">
    <div class="collapse navbar-collapse  w-auto " id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('dashboard', cmp_id=cmp_id, obsc=obsc_key) }}">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <img src="{{ url_for('static', filename='img/bcl/sidenav/dash.svg') }}" width="12px" height="12px" alt="umjini dashboard icon"/>
            </div>
            <span class="text-white nav-link-text ms-1">Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link  " href="{{ url_for('probes', cmp_id=cmp_id, obsc=obsc_key) }}">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <img src="{{ url_for('static', filename='img/bcl/probe.svg') }}" width="12px" height="12px" alt="umjini probes icon"/>
            </div>
            <span class="text-white nav-link-text ms-1">Probes</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link  " href="{{ url_for('alerts', cmp_id=cmp_id, obsc=obsc_key) }}">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <img src="{{ url_for('static', filename='img/bcl/sidenav/alerts.svg') }}" width="12px" height="12px" alt="umjini alerts icon"/>
            </div>
            <span class="text-white nav-link-text ms-1">Alerts</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link  " href="{{ url_for('smartbot', cmp_id=cmp_id, obsc=obsc_key) }}">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <img src="{{ url_for('static', filename='img/bcl/sidenav/ai.svg') }}" width="12px" height="12px" alt="umjini smartbot icon"/>
            </div>
            <span class="text-white nav-link-text ms-1">Chat with SmartBot</span>
          </a>
        </li>
      </ul>
    </div>
    <div class="sidenav-footer mx-3 ">
      <div class="card card-background shadow-none card-background-mask-secondary" id="sidenavCard">
        <div class="full-background" style="background-image: url('/static/img/curved-images/white-curved.jpg')"></div>
        <div class="card-body text-start p-3 w-100">
          <div class="icon icon-shape icon-sm bg-white shadow text-center mb-3 d-flex align-items-center justify-content-center border-radius-md">
            <i class="ni ni-diamond text-dark text-gradient text-lg top-0" aria-hidden="true" id="sidenavCardIcon"></i>
          </div>
          <div class="docs-info">
            
          </div>
        </div>
      </div>
      <a class="btn btn-primary mt-3 w-100"></a>
    </div>
  </aside>
  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg overflow-auto{% if hide_sidebar %} main-content-expanded{% endif %}" style="height: 85vh;">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur" navbar-scroll="true">
      <div class="container-fluid py-1 px-3">
        
        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center">
          </div>
          <ul class="navbar-nav  justify-content-end">
            <li class="nav-item d-xl-none ps-3 d-flex align-items-center mb-3">
              <a href="javascript:;" class="nav-link text-body p-0" id="iconNavbarSidenav">
                <div class="sidenav-toggler-inner">
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                </div>
              </a>
            </li>
            <li class="nav-item dropdown pe-2 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                <i id="notif-bell" class="fa fa-bell cursor-pointer"></i>
              </a>
              <ul id="notif-list" class="dropdown-menu  dropdown-menu-end  px-2 py-3 me-sm-n4" aria-labelledby="dropdownMenuButton">
                
              </ul>
            </li>
            <li class="nav-item dropdown pe-2 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0" id="dropdownSettingsButton" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fa fa-cog cursor-pointer"></i>
              </a>
              <ul id="settings-list" class="dropdown-menu  dropdown-menu-end  px-2 py-3 me-sm-n4" aria-labelledby="dropdownSettingsButton">
                <li><a class="dropdown-item" href="#">Action</a></li>
                <li><a class="dropdown-item" href="#">Another action</a></li>
                <li><a class="dropdown-item" href="#">Something else here</a></li>
                
              </ul>
            </li>
            <li class="nav-item px-3 d-flex align-items-center">
              <a href="{{ url_for('settings', cmp_id=cmp_id, obsc=obsc_key) }}" class="nav-link text-body p-0">
                <i class="fa fa-cog fixed-plugin-button-nav cursor-pointer"></i>
              </a>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a href="{{ url_for('logout', auth_id=cur_usr_id) }}" class="nav-link text-body font-weight-bold px-0">
                <!--<i class="fa fa-user me-sm-1"></i>-->
                <i class="fa-solid fa-right-from-bracket me-sm-1"></i>
                <span class="d-sm-inline d-none">Sign Out</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- End Navbar -->
    <div>
      {% for message in get_flashed_messages() %}
      <div class="alert alert-info alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      {% endfor %}
    </div>
    {% block content %} {% endblock %}
    <footer class="footer pt-3  ">
        <div class="container-fluid">
          <div class="row align-items-center justify-content-lg-between">
            <div class="col-lg-6 mb-lg-0 mb-4">
              <div class="copyright text-center text-sm text-muted text-lg-start">
                Â© <script>
                  document.write(new Date().getFullYear())
                </script>,
                made with <i class="fa fa-heart"></i> by
                <a href="https://baughcl.tech" class="text-white" target="_blank">Baugh Consulting & Lab L.L.C.</a>
                for more practical network management.
              </div>
            </div>
            <div class="col-lg-6">
              <ul class="nav nav-footer justify-content-center justify-content-lg-end">
                <li class="nav-item">
                  <a href="https://baughcl.tech/about.html" class="nav-link text-muted" target="_blank">About Baugh Consulting & Lab L.L.C.</a>
                </li>
                <li class="nav-item">
                  <a href="https://baughcl.tech/services.html" class="nav-link text-muted" target="_blank">Network Engineering Services</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
    </footer>
    <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="notificationModalLabel">Notification</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p id="notif-modal-text"></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!--   Core JS Files   -->
  <!--<script src="../assets/js/core/popper.min.js"></script>-->
  <script src="{{ url_for('static', filename='js/core/popper.min.js') }}" ></script>
  <!--<script src="../assets/js/core/bootstrap.min.js"></script>-->
  <script src="{{ url_for('static', filename='js/core/bootstrap.min.js') }}" ></script>
 
  <!--<script src="../assets/js/plugins/perfect-scrollbar.min.js"></script>-->
  <script src="{{ url_for('static', filename='js/plugins/perfect-scrollbar.min.js') }}" ></script>
  <!--<script src="../assets/js/plugins/smooth-scrollbar.min.js"></script>-->
  <script src="{{ url_for('static', filename='js/plugins/smooth-scrollbar.min.js') }}" ></script>
  <!-- Plotly CDN -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="{{ url_for('static', filename='js/network-visualization.js') }}"></script>
  <script type="text/javascript">
    var csrf_token = "{{ csrf_token() }}";

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrf_token);
            }
        }
    });
  </script>

  <script type="text/javascript">
    const currentUser = "{{ data.get('unm') }}";
    const wsURLMon = "{{ ws_url }}";
    const curUsrID = "{{ cur_usr_id }}"
    const curUser = "{{ cur_usr }}";
    const mntrURL = "{{ mntr_url }}";
    // let accessToken = getCookie("access_token");
    // Use JWT in Sec-WebSocket-Protocol
    const prbExec = document.getElementById("prbExecSwitch");
    let ws = new WebSocket(wsURLMon);
    const notificationModal = new bootstrap.Modal(document.getElementById('notificationModal'));

    function connectWebSocket() {

      ws.onopen = () => {
        console.log("WebSocket connected");

        // Set up an interval to send a message every 5 minutes (300,000 milliseconds)
   
        const intervalId = setInterval(() => {
            if (ws.readyState === WebSocket.OPEN) {
                const message = JSON.stringify({
                  act: "ping",
                  sess_id: "{{ auth_id }}"
                });
                ws.send(message);
                console.log('WebSocket message sent:', message);
            } else {
                console.warn('WebSocket is not open, cannot send message.');
                // Optionally, clear the interval if the connection is permanently closed
                clearInterval(intervalId);
            }
        }, 5 * 60 * 1000); // 5 minutes in milliseconds

        

        ws.onerror = (err) => {
          console.error("WebSocket error:", err);
          clearInterval(intervalId);

        };

        ws.onclose = async (event) => {
          console.warn("WebSocket closed:", event.code, event.reason);
          clearInterval(intervalId);
        };

      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          console.info(data);

          if (data.user_id === curUsrID || data.usr_id === curUsrID) {

            if (data.msg && data.from) {
              const chatWin = document.getElementById(`chat-${data.url}`);
              if(data.final_output){
                if (chatWin) appendMessage(chatWin, data.from, data.msg);
                const spinner = document.getElementById('smartbot-spinner');
                const buttonText = document.getElementById('smartbot-send-txt');
                const smartbotSend = document.getElementById('chat-send');
                spinner.classList.remove('d-inline-block');
                spinner.classList.add('d-none');
                buttonText.textContent = "Send";
                smartbotSend.disabled = false;
              } else {
                if (chatWin) appendMessage(chatWin, data.from, data.msg);
              } 
            } 
          }

          if (data.alert_type){
            addNotification(data);
          }

        } catch (err) {
          console.error("Invalid WS data:", err, event.data);
        }
      };
    }

     // Helper to add notifications to the dropdown list under the bell icon
    function addNotification(data) {
      const list = document.getElementById('notif-list');
      if (!list) return;

      const li = document.createElement('li');
      li.className = 'mb-2';
      li.innerHTML = `
        <a class="dropdown-item border-radius-md" href="javascript:;">
          <div class="d-flex py-1">
            <div class="avatar avatar-sm bg-gradient-warning me-3 my-auto" style="display:flex;align-items:center;justify-content:center;border-radius:6px;width:36px;height:36px;">
              <i class="fa fa-exclamation-triangle text-white" aria-hidden="true" style="font-size:14px;"></i>
            </div>
            <div class="d-flex flex-column justify-content-center">
              <h6 class="text-sm font-weight-normal mb-1">
                <span class="font-weight-bold">${data.alert_type}</span> Alert
              </h6>
              <h4 class="text-sm font-weight-normal mb-0">
                Probe: ${data.name}
                Site: ${data.site}
              </h4>
              <p class="text-xs text-secondary mb-0">
                <i class="fa fa-clock me-1"></i>
                ${data.timestamp}
              </p>
            </div>
          </div>
        </a>
      `;

      // Prepend newest notifications to the top
      if (list.firstChild) {
        list.insertBefore(li, list.firstChild);
      } else {
        list.appendChild(li);
      }

      // Flash the bell icon when a new notification is added
      const bell = document.getElementById('notif-bell');
      if (bell) {
        // Add flash class
        bell.classList.add('bell-flash');

        // Remove flash class after a short period (allowing animation to complete)
        // The CSS sets 3 pulses; remove after ~3s to be safe
        setTimeout(() => {
          bell.classList.remove('bell-flash');
        }, 3000);

        // Also remove flash when user opens the dropdown (click)
        const dropdownBtn = document.getElementById('dropdownMenuButton');
        if (dropdownBtn) {
          const removeFlashOnOpen = () => {
            bell.classList.remove('bell-flash');
            dropdownBtn.removeEventListener('click', removeFlashOnOpen);
          };
          dropdownBtn.addEventListener('click', removeFlashOnOpen);
        }
      }
    }

    connectWebSocket();

    let selectedProbe = document.getElementById("mcp-dropdown");
    const chatInput = document.getElementById("chat-input");
    const chatSend = document.getElementById("chat-send");
    const pcapInit = document.getElementById("pcap-init");
    const scanInit = document.getElementById("scan-init");
    const iperfInit = document.getElementById("iperf-init");
    const trcrtInit = document.getElementById("trcrt-init");
    const taskToggleInit = document.getElementById('task-toggle-init');
    const taskRescheduleInit = document.getElementById('task-reschedule-init');
    const taskDeleteInit = document.getElementById('task-delete-init');
    const taskSmartBotSwitch = document.getElementById('taskSmartBotSwitch');
    const taskSmartBotPrompt = document.getElementById('taskSmartBotPrompt');
    const netvisRunTraceButton = document.getElementById('netvis-trace-run-btn');
    const netvisRunPerfButton = document.getElementById('netvis-perf-run-btn');
    const netvisRunScanButton = document.getElementById('netvis-scan-run-btn');
    const netvisRunPcapButton = document.getElementById('netvis-pcap-run-btn');
    const flowScheduleInit = document.getElementById('flow-schedule-init');
    const taskExecSwitch = document.getElementById('taskExecSwitch');
    const deleteFlowButton = document.getElementById('delete-flow');

    function appendMessage(chatWin, from, text) {
      chatWin.innerHTML+= `<p><strong>${from}</strong></p>`;

      // Split the message into lines and append each line separately
      const lines = text.split(/\r?\n/);
      for (const line of lines) {
        // Append line only if not empty, otherwise add a break for blank lines
        if (line.trim() !== "") {
          chatWin.innerHTML += `<p>${line}</p>`;
        } else {
          chatWin.innerHTML += `<br>`;
        }
      }
      
    }

    function appendUserMessage(chatWin, from, text) {
      chatWin.innerHTML+= `<p><strong>${from}</strong> ${text}</p>`;
    }

    // show selected chat window
    function showChat(url) {
      document.querySelectorAll(".chat-window").forEach(w => w.style.display = "none");
      const chatWin = document.getElementById(`chat-${url}`);
      if (chatWin) chatWin.style.display = "block";
    }

    // load history for chat
    function loadChat(url, user) {
      showChat(url);
      ws.send(JSON.stringify({
        act: "hist",
        url: url,
        usr: user
      }));
    }

    // send message
    function sendMessage() {
      const spinner = document.getElementById('smartbot-spinner');
      const buttonText = document.getElementById('smartbot-send-txt');
      const smartbotSend = document.getElementById('chat-send');

      // Show the spinner and hide the text
      spinner.classList.remove('d-none');
      spinner.classList.add('d-inline-block');
      buttonText.textContent = "Processing...";
      smartbotSend.disabled = true;
                
      if (!selectedProbe.value || !chatInput.value.trim()) {
        spinner.classList.remove('d-inline-block');
        spinner.classList.add('d-none');
        buttonText.textContent = "Send";
        smartbotSend.disabled = false;

        document.getElementById('notificationModalLabel').textContent = 'Missing Probe selection or Chat Query';
        document.getElementById('notif-modal-text').innerText = 'Make a probe selection or enter a chat query.. Please provide the necessary information and try again.';

        notificationModal.show();
      }

      const msg = chatInput.value.trim();
      chatInput.value = "";

      ws.send(JSON.stringify({
        act: "smartbot_chat",
        url: selectedProbe.value,
        usr: currentUser,
        prb_id: selectedProbe.dataset.pid,
        from: "user",
        msg: msg,
        usr_id: curUsrID
      }));

      const chatWin = document.getElementById(`chat-${selectedProbe.value}`);
      showChat(selectedProbe.value);
      appendUserMessage(chatWin, "user", msg);
    }

    // LLM Chat event listeners
    chatSend.addEventListener("click", sendMessage);

    flowScheduleInit.addEventListener("click", async function() {

      const spinner = this.querySelector('.spinner-grow');
      const buttonText = this.querySelector('.flow-schedule-button-text');

      const flowDays = document.getElementById('flow-days');
      const flowMonths = document.getElementById('flow-months');
      const flowHours = document.getElementById('flow-hours');
      const flowMinutes = document.getElementById('flow-minutes');
      const flowDom = document.getElementById('flow-dom');

      if (!flowDays.value && !flowMonths.value && !flowHours.value && !flowMinutes.value && !flowDom.value) {
        document.getElementById('notificationModalLabel').textContent = 'Missing Schedule Parameters';
        document.getElementById('notif-modal-text').innerText = 'Please provide at least one scheduling parameter (days, months, hours, minutes, or day of month) to schedule the flow task.';
        notificationModal.show();
        return;
      }

      spinner.classList.remove('d-none');
      spinner.classList.add('d-inline-block');
      buttonText.textContent = "Scheduling Flow...";
      this.disabled = true;

      const id = document.getElementById('flow-schedule-id-holder').dataset.id;
      const name = document.getElementById('flow-schedule-name-holder').dataset.name;
      const prb_id = document.getElementById('flow-schedule-prb_id-holder').dataset.prb_id;
      const flow = document.getElementById('flow-schedule-flow-holder').dataset.flow;

      let taskData = {
        "act": "prb_task_init",
        "prb_id": prb_id,
        "user_id": curUsrID,
        "flow": flow,
        "flow_name": name,
        "flow_id": id,
        "oper": "init_task",
      };

      if (flowDays.value){
        taskData["days"] = flowDays.value;
      }

      if (flowMonths.value){
        taskData["months"] = flowMonths.value;
      }

      if (flowHours.value){
        taskData["hours"] = flowHours.value;
      }

      if (flowMinutes.value){
        taskData["minutes"] = flowMinutes.value;
      }

      if (flowDom.value){
        taskData["dom"] = flowDom.value;
      }

      ws.send(JSON.stringify(taskData));

      spinner.classList.remove('d-inline-block');
      spinner.classList.add('d-none');
      buttonText.textContent = "Schedule Flow";
      this.disabled = false;

      document.getElementById('notificationModalLabel').textContent = 'Flow Task Scheduled';
      document.getElementById('notif-modal-text').innerText = `Flow ${name} is being scheduled on probe ${prb_id}. You will receive a notification when it has been initiated.`;
      notificationModal.show();
    });

    // Probe Task init event listeners
    trcrtInit.addEventListener("click", async function () {
      // Select the spinner element within the button
      const spinner = this.querySelector('.spinner-grow');
      // Select the text element within the button
      const buttonText = this.querySelector('.prb-tsk-trc-button-text');

      // Show the spinner and hide the text
      spinner.classList.remove('d-none');
      spinner.classList.add('d-inline-block');
      buttonText.textContent = "Tracing...";
      
      // Disable the button
      this.disabled = true;

      const traceType = document.getElementById("trcrt-dropdown").value;
      const traceTarget = document.getElementById("trcrt-target").value;
      const traceDNSServer = document.getElementById("trcrt-dns-test-server").value;
      const traceOptions = document.getElementById("trcrt-options").value;
      const tracePacketLen = document.getElementById("trcrt-packetlen").value;
      const current_pid =  this.dataset.pid;

      const taskDays = document.getElementById('task-days');
      const taskMonths = document.getElementById('task-months');
      const taskHours = document.getElementById('task-hours');
      const taskMinutes = document.getElementById('task-minutes');
      const taskDom = document.getElementById('task-dom');
      

      if (!traceType || !traceTarget) {
        spinner.classList.remove('d-inline-block');
        spinner.classList.add('d-none');
        buttonText.textContent = "Test";
        
        // Enable the button
        this.disabled = false;

        document.getElementById('notificationModalLabel').textContent = 'Missing Parameters';
        document.getElementById('notif-modal-text').innerText = 'Missing required task parameter(s). Please provide the necessary information and try again.';

        notificationModal.show();
      }

      let taskData = {
        "act": "prb_task_init",
        "auto_type": 'task',
        "prb_id": current_pid,
        "task": traceType,
        "user_id": curUsrID,
        "prms": {
          "target": traceTarget
        }
      };

      if (taskSmartBotSwitch.checked && taskSmartBotPrompt.value.trim()) {
        taskData["llm"] = 'smartbot';
        taskData["llm_data"] = { "prompt": taskSmartBotPrompt.value.trim() };
        taskData["alerts"] = {};
        taskData["alerts"]["tools"] = document.getElementById('taskAlertDropdown').value;
      }

      if (taskDays.value){
        taskData["days"] = taskDays.value;
      }

      if (taskMonths.value){
        taskData["months"] = taskMonths.value;
      }

      if (taskHours.value){
        taskData["hours"] = taskHours.value;
      }

      if (taskMinutes.value){
        taskData["minutes"] = taskMinutes.value;
      }

      if (taskDom.value){
        taskData["dom"] = taskDom.value;
      }

      if (traceDNSServer) {
        taskData["prms"]["server"] = traceDNSServer;
      }

      if (traceOptions) {
        taskData["prms"]["options"] = traceOptions;
      }

      if (tracePacketLen) {
        taskData["prms"]["packetlen"] = tracePacketLen;
      }

      if (taskExecSwitch.checked) {
        taskData["oper"] = "exec";

        ws.send(JSON.stringify(taskData));

        spinner.classList.remove('d-inline-block');
        spinner.classList.add('d-none');
        buttonText.textContent = "Scan";

        this.disabled = false;

        traceType.value = "";
        traceTarget.value = "";
        traceDNSServer.value = "";
        traceOptions.value = "";
        tracePacketLen.value = "";
        taskSmartBotSwitch.checked = false;
        taskSmartBotPrompt.value = "";
        taskExecSwitch.checked = false;
        taskDays.value = "";
        taskMonths.value = "";
        taskHours.value = "";
        taskMinutes.value = "";
        taskDom.value = "";

        document.getElementById('notificationModalLabel').textContent = `Performance Test Task Executed`;
        document.getElementById('notif-modal-text').innerText = `Performance test task executed immediately. You will receive a notification when the test is complete and the results are available for review.`;

        notificationModal.show();

        return;
      }

      taskData["oper"] = "init_task";

      ws.send(JSON.stringify(taskData));

      spinner.classList.remove('d-inline-block');
      spinner.classList.add('d-none');
      buttonText.textContent = "Trace";
      
      // Enable the button
      this.disabled = false;

      traceType.value = "";
      traceTarget.value = "";
      traceDNSServer.value = "";
      traceOptions.value = "";
      tracePacketLen.value = "";
      taskSmartBotSwitch.checked = false;
      taskSmartBotPrompt.value = "";
      taskExecSwitch.checked = false;
      taskDays.value = "";
      taskMonths.value = "";
      taskHours.value = "";
      taskMinutes.value = "";
      taskDom.value = "";

      document.getElementById('notificationModalLabel').textContent = 'Traceroute Task Initiated';
      document.getElementById('notif-modal-text').innerText = 'Network path trace task initiated. You will receive a notification when the trace is complete and the results are available for review.';

      notificationModal.show();
    });

    iperfInit.addEventListener("click", async function () {
      // Select the spinner element within the button
      const spinner = this.querySelector('.spinner-grow');
      // Select the text element within the button
      const buttonText = this.querySelector('.prb-tsk-spd-button-text');

      // Show the spinner and hide the text
      spinner.classList.remove('d-none');
      spinner.classList.add('d-inline-block');
      buttonText.textContent = "Testing...";
      
      // Disable the button
      this.disabled = true;

      const spdtstType = document.getElementById("spdtst-dropdown").value;
      const spdtstClientOptions = document.getElementById("spdtst-clnt-options").value;
      const spdtstOptions = document.getElementById("spdtst-options").value;
      const current_pid =  this.dataset.pid;

      const taskDays = document.getElementById('task-days');
      const taskMonths = document.getElementById('task-months');
      const taskHours = document.getElementById('task-hours');
      const taskMinutes = document.getElementById('task-minutes');
      const taskDom = document.getElementById('task-dom');

      if (!spdtstType) {
        spinner.classList.remove('d-inline-block');
        spinner.classList.add('d-none');
        buttonText.textContent = "Test";
        
        // Enable the button
        this.disabled = false;

        document.getElementById('notificationModalLabel').textContent = 'Missing Parameters';
        document.getElementById('notif-modal-text').innerText = 'Missing required task parameter(s). Please provide the necessary information and try again.';

        notificationModal.show();
      }

      let taskData = {
        "act": "prb_task_init",
        "prb_id": current_pid,
        "task": spdtstType,
        "user_id": curUsrID,
      };

      if (spdtstClientOptions && spdtstType === "spdtst_clnt") {
        taskData["prms"]["server"] = spdtstClientOptions;
      }

      if (spdtstOptions) {
        taskData["prms"]["options"] = spdtstOptions;
      }

      if (taskSmartBotSwitch.checked && taskSmartBotPrompt.value.trim()) {
        taskData["llm"] = 'smartbot';
        taskData["llm_data"] = { "prompt": taskSmartBotPrompt.value.trim() };
        taskData["alerts"] = {};
        taskData["alerts"]["tools"] = document.getElementById('taskAlertDropdown').value;
      }

      if (taskExecSwitch.checked) {
        taskData["oper"] = "exec";

        ws.send(JSON.stringify(taskData));

        spinner.classList.remove('d-inline-block');
        spinner.classList.add('d-none');
        buttonText.textContent = "Scan";

        this.disabled = false;

        spdtstClientOptions.value = "";
        spdtstOptions.value = "";
        taskSmartBotSwitch.checked = false;
        taskSmartBotPrompt.value = "";
        taskExecSwitch.checked = false;
        taskDays.value = "";
        taskMonths.value = "";
        taskHours.value = "";
        taskMinutes.value = "";
        taskDom.value = "";

        document.getElementById('notificationModalLabel').textContent = `Performance Test Task Executed`;
        document.getElementById('notif-modal-text').innerText = `Performance test task executed immediately. You will receive a notification when the test is complete and the results are available for review.`;

        notificationModal.show();

        return;
      }

      if (taskDays.value){
        taskData["days"] = taskDays.value;
      }

      if (taskMonths.value){
        taskData["months"] = taskMonths.value;
      }

      if (taskHours.value){
        taskData["hours"] = taskHours.value;
      }

      if (taskMinutes.value){
        taskData["minutes"] = taskMinutes.value;
      }

      if (taskDom.value){
        taskData["dom"] = taskDom.value;
      }

      taskData["oper"] = "init_task";

      ws.send(JSON.stringify(taskData));

      spinner.classList.remove('d-inline-block');
      spinner.classList.add('d-none');
      buttonText.textContent = "Test";
      
      // Enable the button
      this.disabled = false;

      spdtstClientOptions.value = "";
      spdtstOptions.value = "";
      taskSmartBotSwitch.checked = false;
      taskSmartBotPrompt.value = "";
      taskExecSwitch.checked = false;
      taskDays.value = "";
      taskMonths.value = "";
      taskHours.value = "";
      taskMinutes.value = "";
      taskDom.value = "";

      document.getElementById('notificationModalLabel').textContent = 'Performance Test Task Initiated';
      document.getElementById('notif-modal-text').innerText = 'Network performance test initiated. You will receive a notification when the test is complete and the results are available for review.';

      notificationModal.show();
      
    });

    scanInit.addEventListener("click", async function () {
      // Select the spinner element within the button
      const spinner = this.querySelector('.spinner-grow');
      // Select the text element within the button
      const buttonText = this.querySelector('.prb-tsk-spd-button-text');

      // Show the spinner and hide the text
      spinner.classList.remove('d-none');
      spinner.classList.add('d-inline-block');
      buttonText.textContent = "Scanning...";
      
      // Disable the button
      this.disabled = true;

      const scanType = document.getElementById("scan-dropdown").value;
      const scanTarget = document.getElementById("scan-target").value;
      const scanInterface = document.getElementById("scan-interface").value;
      const scanOptions = document.getElementById("scan-options").value;
      const current_pid =  this.dataset.pid;

      const taskDays = document.getElementById('task-days');
      const taskMonths = document.getElementById('task-months');
      const taskHours = document.getElementById('task-hours');
      const taskMinutes = document.getElementById('task-minutes');
      const taskDom = document.getElementById('task-dom');

      if (!scanType && !scanTarget) {
        spinner.classList.remove('d-inline-block');
        spinner.classList.add('d-none');
        buttonText.textContent = "Scan";
        
        // Enable the button
        this.disabled = false;

        document.getElementById('notificationModalLabel').textContent = 'Missing Parameters';
        document.getElementById('notif-modal-text').innerText = 'Missing required task parameter(s). Please provide the necessary information and try again.';

        notificationModal.show();
      }

      let taskData = {
        "act": "prb_task_init",
        "prb_id": current_pid,
        "task": scanType,
        "user_id": curUsrID,
        "prms": {
          "subnet": scanTarget
        }
      };

      if (scanInterface) {
        taskData["interface"] = scanInterface;
      }

      if (scanOptions && scanType === "scan_custom") {
        taskData["prms"]["options"] = scanOptions;
      }

      if (taskSmartBotSwitch.checked && taskSmartBotPrompt.value.trim()) {
        taskData["llm"] = 'smartbot';
        taskData["llm_data"] = { "prompt": taskSmartBotPrompt.value.trim() };
        taskData["alerts"] = {};
        taskData["alerts"]["tools"] = document.getElementById('taskAlertDropdown').value;
      }

      if (taskExecSwitch.checked) {
        taskData["oper"] = "exec";

        ws.send(JSON.stringify(taskData));

        spinner.classList.remove('d-inline-block');
        spinner.classList.add('d-none');
        buttonText.textContent = "Scan";

        this.disabled = false;

        scanInterface.value = "";
        scanOptions.value = "";
        taskSmartBotSwitch.checked = false;
        taskSmartBotPrompt.value = "";
        taskExecSwitch.checked = false;
        taskDays.value = "";
        taskMonths.value = "";
        taskHours.value = "";
        taskMinutes.value = "";
        taskDom.value = "";

        document.getElementById('notificationModalLabel').textContent = `${scanType} Scan Task Executed`;
        document.getElementById('notif-modal-text').innerText = `${scanType} scan task executed immediately. You will receive a notification when the scan is complete and the results are available for review.`;

        notificationModal.show();

        return;
      }

      if (taskDays.value){
        taskData["days"] = taskDays.value;
      }

      if (taskMonths.value){
        taskData["months"] = taskMonths.value;
      }

      if (taskHours.value){
        taskData["hours"] = taskHours.value;
      }

      if (taskMinutes.value){
        taskData["minutes"] = taskMinutes.value;
      }

      if (taskDom.value){
        taskData["dom"] = taskDom.value;
      }

      taskData["oper"] = "init_task";

      ws.send(JSON.stringify(taskData));

      spinner.classList.remove('d-inline-block');
      spinner.classList.add('d-none');
      buttonText.textContent = "Scan";
      
      // Enable the button
      this.disabled = false;

      scanInterface.value = "";
      scanOptions.value = "";
      taskSmartBotSwitch.checked = false;
      taskSmartBotPrompt.value = "";
      taskExecSwitch.checked = false;
      taskDays.value = "";
      taskMonths.value = "";
      taskHours.value = "";
      taskMinutes.value = "";
      taskDom.value = "";

      document.getElementById('notificationModalLabel').textContent = `${scanType} Scan Task Initiated`;
      document.getElementById('notif-modal-text').innerText = `${scanType} scan task initiated. You will receive a notification when the scan is complete and the results are available for review.`;

      notificationModal.show();
      
    });

    pcapInit.addEventListener("click", async function () {
      // Select the spinner element within the button
      const spinner = this.querySelector('.spinner-grow');
      // Select the text element within the button
      const buttonText = this.querySelector('.prb-tsk-spd-button-text');

      // Show the spinner and hide the text
      spinner.classList.remove('d-none');
      spinner.classList.add('d-inline-block');
      buttonText.textContent = "Scanning...";
      
      // Disable the button
      this.disabled = true;

      const pcapType = document.getElementById("pcap-dropdown").value;
      const pcapInterface = document.getElementById("pcap-interface").value;
      const pcapCount = document.getElementById("pcap-count-target").value;
      const pcapDuration = document.getElementById("pcap-duration-target").value;
      const current_pid =  this.dataset.pid;

      const taskDays = document.getElementById('task-days');
      const taskMonths = document.getElementById('task-months');
      const taskHours = document.getElementById('task-hours');
      const taskMinutes = document.getElementById('task-minutes');
      const taskDom = document.getElementById('task-dom');

      if (!pcapType) {
        spinner.classList.remove('d-inline-block');
        spinner.classList.add('d-none');
        buttonText.textContent = "Scan";
        
        // Enable the button
        this.disabled = false;

        document.getElementById('notificationModalLabel').textContent = 'Missing Parameters';
        document.getElementById('notif-modal-text').innerText = 'Missing required task parameter(s). Please provide the necessary information and try again.';

        notificationModal.show();
      }

      let taskData = {
        "act": "prb_task_init",
        "prb_id": current_pid,
        "task": pcapType,
        "user_id": curUsrID,
      };

      if (pcapInterface && pcapType != "pcap_lcl") {
        taskData["prms"]["remote_iface"] = pcapInterface;
      }

      if (pcapInterface && pcapType === "pcap_lcl") {
        taskData["prms"]["interface"] = pcapInterface;
      }
      if (pcapDuration && pcapType !== "pcap_win") {
        taskData["prms"]["duration"] = pcapDuration;
      }

      if (pcapCount && pcapType === "pcap_tux") {
        taskData["prms"]["cap_count"] = pcapCount;
      }

      if (taskSmartBotSwitch.checked && taskSmartBotPrompt.value.trim()) {
        taskData["llm"] = 'smartbot';
        taskData["llm_data"] = { "prompt": taskSmartBotPrompt.value.trim() };
        taskData["alerts"] = {};
        taskData["alerts"]["tools"] = document.getElementById('taskAlertDropdown').value;
      }

      if (taskExecSwitch.checked) {
        taskData["oper"] = "exec";

        ws.send(JSON.stringify(taskData));

        spinner.classList.remove('d-inline-block');
        spinner.classList.add('d-none');
        buttonText.textContent = "Scan";

        this.disabled = false;

        pcapInterface.value = "";
        pcapCount.value = "";
        pcapDuration.value = "";
        taskSmartBotSwitch.checked = false;
        taskSmartBotPrompt.value = "";
        taskExecSwitch.checked = false;
        taskDays.value = "";
        taskMonths.value = "";
        taskHours.value = "";
        taskMinutes.value = "";
        taskDom.value = "";

        document.getElementById('notificationModalLabel').textContent = 'Packet Capture Task Executed';
        document.getElementById('notif-modal-text').innerText = 'Packet capture task executed immediately. You will receive a notification when the capture is complete and the results are available for review.';

        notificationModal.show();

        return;
      }

      if (taskDays.value){
        taskData["days"] = taskDays.value;
      }

      if (taskMonths.value){
        taskData["months"] = taskMonths.value;
      }

      if (taskHours.value){
        taskData["hours"] = taskHours.value;
      }

      if (taskMinutes.value){
        taskData["minutes"] = taskMinutes.value;
      }

      if (taskDom.value){
        taskData["dom"] = taskDom.value;
      }

      taskData["oper"] = "init_task";

      ws.send(JSON.stringify(taskData));

      spinner.classList.remove('d-inline-block');
      spinner.classList.add('d-none');
      buttonText.textContent = "Scan";

      pcapInterface.value = "";
      pcapCount.value = "";
      pcapDuration.value = "";
      taskSmartBotSwitch.checked = false;
      taskSmartBotPrompt.value = "";
      taskExecSwitch.checked = false;
      taskDays.value = "";
      taskMonths.value = "";
      taskHours.value = "";
      taskMinutes.value = "";
      taskDom.value = "";
      
      
      // Enable the button
      this.disabled = false;

      document.getElementById('notificationModalLabel').textContent = 'Packet Capture Task Initiated';
      document.getElementById('notif-modal-text').innerText = 'Packet capture task initiated. You will receive a notification when the capture is complete and the results are available for review.';

      notificationModal.show();
      
    });

    taskToggleInit.addEventListener("click", function () {
      // Select the spinner element within the button
      const spinner = this.querySelector('.spinner-grow');
      // Select the text element within the button
      const buttonText = this.querySelector('.tsk-enable-button-text');

      // Show the spinner and hide the text
      spinner.classList.remove('d-none');
      spinner.classList.add('d-inline-block');
      buttonText.textContent = "Toggling...";

      // Disable the button
      this.disabled = true;
      
      const probe_id = document.getElementById("task-toggle-prb_id-holder");
      const enabled = document.getElementById("task-toggle-enabled-holder");
      const comment = document.getElementById("task-toggle-comment-holder");
      const name = document.getElementById("task-toggle-name-holder");
      const id = document.getElementById("task-toggle-id-holder").dataset.id;

      let taskData = {
        "act": "prb_task_init",
        "prb_id": probe_id.dataset.prb_id,
        "comment": comment.dataset.comment,
        "task_id": id,
        "user_id": curUsrID
      };  

      if (enabled.dataset.enabled === "enabled"){
        taskData["enabled"] = "disabled";
        taskData["oper"] = "disable_task";
        buttonText.textContent = "Disabling...";
      } else {
        taskData["enabled"] = "enabled";
        taskData["oper"] = "enable_task";
        buttonText.textContent = "Enabling...";
      }
      ws.send(JSON.stringify(taskData));

      spinner.classList.remove('d-inline-block');
      spinner.classList.add('d-none');
      buttonText.textContent = "Enable/Disable";
      
      // Enable the button
      this.disabled = false;

      document.getElementById('notificationModalLabel').textContent = `Task Toggle Initiated`;
      document.getElementById('notif-modal-text').innerText = `task ${name.dataset.name} was ${taskData["enabled"]}. You will receive a notification when the task has been successfully toggled.`;

      notificationModal.show();
    });

    taskRescheduleInit.addEventListener("click", function () {
      // Select the spinner element within the button
      const spinner = this.querySelector('.spinner-grow');
      // Select the text element within the button
      const buttonText = this.querySelector('.tsk-reschedule-button-text');

      // Show the spinner and hide the text
      spinner.classList.remove('d-none');
      spinner.classList.add('d-inline-block');
      buttonText.textContent = "Rescheduling...";

      // Disable the button
      this.disabled = true;
      
      const probe_id = document.getElementById("task-reschedule-prb_id-holder");
      const enabled = document.getElementById("task-reschedule-enabled-holder");
      const comment = document.getElementById("task-reschedule-comment-holder");
      const name = document.getElementById("task-reschedule-name-holder");
      const id = document.getElementById("task-reschedule-id-holder").dataset.id;

      const days = document.getElementById("task-reschedule-days");
      const months = document.getElementById("task-reschedule-months");
      const hours = document.getElementById("task-reschedule-hours");
      const minutes = document.getElementById("task-reschedule-minutes");
      const dom = document.getElementById("task-reschedule-dom");

      let taskData = {
        "act": "prb_task_init",
        "prb_id": probe_id.dataset.prb_id,
        "comment": comment.dataset.comment,
        "task_id": id,
        "user_id": curUsrID
      };  

      if (!days.value && !months.value && !hours.value && !minutes.value && !dom.value && !smartbotSwitch.checked && !flowbotSwitch.checked){
        spinner.classList.remove('d-inline-block');
        spinner.classList.add('d-none');
        buttonText.textContent = "Reschedule";
        
        // Enable the button
        this.disabled = false;

        document.getElementById('notificationModalLabel').textContent = 'Missing Parameters';
        document.getElementById('notif-modal-text').innerText = 'No rescheduling parameters provided. Please provide at least one parameter to update the task schedule and try again.';

        notificationModal.show();
      }
      
      if(days.value){
        taskData["days"] = days.value;
      }
      
      if (months.value){
        taskData["months"] = months.value;
      }

      if (hours.value){
        taskData["hours"] = hours.value;
      }

      if (minutes.value){
        taskData["minutes"] = minutes.value; 
      }

      if (dom.value){
        taskData["dom"] = dom.value;
      }

      taskData["oper"] = "resch_task";

      ws.send(JSON.stringify(taskData));

      spinner.classList.remove('d-inline-block');
      spinner.classList.add('d-none');
      buttonText.textContent = "Reschedule";
      
      // Enable the button
      this.disabled = false;

      document.getElementById('notificationModalLabel').textContent = `Task ${name.dataset.name} Rescheduled`;
      document.getElementById('notif-modal-text').innerText = `task ${name.dataset.name} reschedule has been successfully initiated.`;

      notificationModal.show();
    });

    taskDeleteInit.addEventListener("click", async function () {
      // Select the spinner element within the button
      const spinner = this.querySelector('.spinner-grow');
      // Select the text element within the button
      const buttonText = this.querySelector('.tsk-delete-button-text');

      // Show the spinner and hide the text
      spinner.classList.remove('d-none');
      spinner.classList.add('d-inline-block');
      buttonText.textContent = "Deleting...";
      
      // Disable the button
      this.disabled = true;

      const probe_id = document.getElementById("task-delete-prb_id-holder");
      const comment = document.getElementById("task-delete-comment-holder");
      const name = document.getElementById("task-delete-name-holder");
      const id = document.getElementById("task-delete-id-holder").dataset.id;

      let taskData = {
        "act": "prb_task_init",
        "prb_id": probe_id.dataset.prb_id,
        "comment": comment.dataset.comment,
        "oper": "rm_task",
        "task_id": id,
        "user_id": curUsrID

      };  

      ws.send(JSON.stringify(taskData));

      spinner.classList.remove('d-inline-block');
      spinner.classList.add('d-none');
      buttonText.textContent = "Delete";
      
      // Enable the button
      this.disabled = false;

      document.getElementById('notificationModalLabel').textContent = `Task ${name.dataset.name} Deletion Initiated`;
      document.getElementById('notif-modal-text').innerText = `task ${name.dataset.name} deletion initiated. You will receive a notification when the task has been successfully deleted.`;

      notificationModal.show();
    });

    deleteFlowButton.addEventListener('click', async function() {
      const id = document.getElementById("flow-delete-id-holder").dataset.id;
      const probe = document.getElementById("flow-delete-probe-holder").dataset.probe;
      const comment = document.getElementById("flow-delete-comment-holder").dataset.comment;
      const spinner = this.querySelector('.spinner-grow');
      const buttonText = this.querySelector('.flow-delete-button-text');
      const commentText = document.getElementById("flow-delete-comment-holder");
      const payload = { id: id, probe: probe };

      // Show the spinner and hide the text
      spinner.classList.remove('d-none');
      spinner.classList.add('d-inline-block');
      buttonText.textContent = "Deleting...";
      
      // Disable the button
      this.disabled = true;

      try {
        const resp = await fetch(`https://${mntrURL}/v1/api/core/flow/delete?usr=${curUser}`, {method: 'POST', credentials: "same-origin", headers: {"Content-Type": "application/json"}, body: JSON.stringify(payload)});

        if (resp.ok) {
          const j = await resp.json()

          let taskData = {
            "act": "prb_task_init",
            "prb_id": probe_id.dataset.prb_id,
            "comment": comment.dataset.comment,
            "oper": "rm_task",
            "task_id": id,
            "user_id": curUsrID

          };  

          ws.send(JSON.stringify(taskData));

          spinner.classList.remove('d-inline-block');
          spinner.classList.add('d-none');
          buttonText.textContent = "Delete";
          
          // Enable the button
          this.disabled = false;


          document.getElementById('notificationModalLabel').textContent = `Flow Deletion Initiated`;
          document.getElementById('notif-modal-text').innerText = `Flow deletion for flow ${id} on probe ${probe} has been initiated. You will receive a notification when the flow has been successfully deleted.`;
          notificationModal.show();
        } else {
          document.getElementById('notificationModalLabel').textContent = 'Flow Deletion Failed';
          document.getElementById('notif-modal-text').innerText = `Flow deletion for flow ${id} on probe ${probe} failed to initiate. Please try again. If the issue persists, contact support.`;
          notificationModal.show();
        }
      } catch (err) {
        console.error('Network or server error:', err);
      }
    });

    chatInput.addEventListener("keypress", e => {
      if (e.key === "Enter") sendMessage();
    });

    // chat selection
    document.querySelectorAll("#mcp-list li").forEach(li => {
      li.addEventListener("click", () => {
        selectedProbe.value = li.dataset.value;
        showChat(selectedProbe.value);
        document.getElementById("mcp-dropdown").value = selectedProbe.value;
        selectedProbe.dataset.pid = li.dataset.pid;
      });
    });
    document.getElementById("mcp-dropdown").addEventListener("change", e => {
      selectedProbe.value = e.target.value;
      selectedProbe.dataset.pid = e.target.selectedOptions[0].dataset.pid;
      showChat(selectedProbe.value);
    });
    // close all modals but the one you want to open
    const $modals = document.querySelectorAll('.modal');
    $modals.forEach(modal => {
      modal.addEventListener('show.bs.modal', function() {
        $modals.forEach(_modal => {
          let currentModal = bootstrap.Modal.getInstance(_modal);
          if (this !== _modal && currentModal) {
            currentModal.hide();
          }
        });
      });
    });
  </script>
 
  <script>
    var win = navigator.platform.indexOf('Win') > -1;
    if (win && document.querySelector('#sidenav-scrollbar')) {
      var options = {
        damping: '0.5'
      }
      Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
    }
  </script>
  <!-- Github buttons -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <!-- Control Center for Soft Dashboard: parallax effects, scripts for the example pages etc -->
  <!--<script src="../assets/js/soft-ui-dashboard.min.js?v=1.1.0"></script>-->
  <script src="{{ url_for('static', filename='js/soft-ui-dashboard.min.js') }}" ></script>
</body>

</html>