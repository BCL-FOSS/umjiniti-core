{% extends 'app/base.html' %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-header pb-0">
          <h6>umjiniti AI Network Admin Assistant</h6>
        </div>
        <div class="card-body px-0 pt-0 pb-2">
          <div class="row">
            <!-- Left: MCP selection -->
            <div class="col-md-6 col-lg-5 col-xl-4 mb-4 mb-md-0">
              <div class="p-3">
                <!-- Dropdown -->
                <div class="mb-3">
                  <label for="mcp-dropdown" class="form-label">Select MCP Option:</label>
                  <select id="mcp-dropdown" class="form-select">
                    {% for opt in options.values() %}
                      <option value="{{ opt.url }}/llm/mcp" data-pid="{{ opt.prb_id }}">{{ opt.name }}</option>
                    {% endfor %}
                  </select>
                </div>

                <!-- List -->
                <div style="position: relative; height: 400px; overflow-y:auto;" id="mcp-list-container">
                  <ul class="list-unstyled mb-0" id="mcp-list">
                    {% for opt in options.values() %}
                      <li class="p-2 border-bottom" data-value="{{ opt.url }}/llm/mcp" data-pid="{{ opt.prb_id }}">
                        <a href="#!" class="d-flex justify-content-between">
                          <div class="d-flex flex-row">
                            <img src="{{ url_for('static', filename='img/bcl/' + opt.status + '.svg') }}" alt="probe-status"
                              class="d-flex align-self-center me-3" width="60"/>
                            <div class="pt-1">
                              <p class="fw-bold mb-0">Probe: {{ opt.name }}</p>
                              <p class="small text-muted">Site: {{ opt.site }}</p>
                              <p class="small text-muted">Host Ports: {{ opt.iface_list }}</p>
                              <p class="small text-muted">URL: {{ opt.url }}/llm/mcp</p>
                              
                            </div>
                            <div class="input-group mb-3">
                              <a href="{{ url_for('dashboard', cmp_id=cmp_id, obsc=obsc_key, prb_id=opt.prb_id) }}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                View Dashboard
                              </a>
                              <a href="{{ url_for('probe', cmp_id=cmp_id, obsc=obsc_key, prb_id=opt.prb_id) }}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                Admin Panel
                              </a>
                              <a href="{{ url_for('floweditor', cmp_id=cmp_id, obsc=obsc_key, prb_id=opt.prb_id) }}" target="_blank" class="btn btn-sm btn-outline-secondary ms-2">
                                New WorkFlow
                              </a>
                              <a href="{{ url_for('chats', cmp_id=cmp_id, obsc=obsc_key, usr=cur_usr, prb_id=opt.prb_id) }}" target="_blank" class="btn btn-sm btn-outline-info ms-2">
                                Chat History
                              </a>
                              <button class="btn btn-sm btn-outline-danger ms-2 probe-delete-btn"
                                  data-name="{{ opt.name|e }}"
                                  data-url="{{ opt.url|e }}"
                                  data-site="{{ opt.site|e }}"
                                  data-id="{{ opt.prb_id|e }}">
                                Delete Probe
                              </button>
                            </div>
                          </div>
                        </a>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              </div>
            </div>

            <!-- Right: Chat (multiple windows) -->
            <div class="col-md-6 col-lg-7 col-xl-8">
              <div id="chat-container" style="height: 500px; overflow-y: auto;" class="border p-3 mb-3">
                {% for opt in options.values() %}
                  <div class="chat-window" id="chat-{{ opt.url }}/llm/mcp" style="display: none; height:100%; overflow-y:auto;"></div>
                {% endfor %}
              </div>
              <div class="input-group">
                <input type="text" id="chat-input" class="form-control" placeholder="Type a message...">
                <button id="chat-send" class="btn btn-primary">
                  <span class="spinner-grow spinner-grow-sm d-none" role="status" aria-hidden="true" id="smartbot-spinner"></span>
                  <span class="smartbot-button-text" id="smartbot-send-txt">Send</span>
                </button>
              </div>
            </div>
          </div> 
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="probeDeleteModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="probeDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="probeDeleteModalLabel">Delete Probe</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this probe?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger" id="delete-probe">
          <span class="spinner-grow spinner-grow-sm d-none" role="status" aria-hidden="true"></span>
          <span class="prb-delete-button-text">Delete</span>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .chat-message { margin-bottom: 8px; }
  .chat-message.user { text-align: right; }
  .chat-message.agent { text-align: left; }
</style>

<script type="text/javascript">
  const mntrURL = "{{ mntr_url }}";
  const notificationModal = new bootstrap.Modal(document.getElementById('notificationModal'));

  const probeDeleteButtons = document.querySelectorAll(".probe-delete-btn");
  const deleteProbeButton = document.getElementById('delete-probe');

  const deleteModal = new bootstrap.Modal(document.getElementById('probeDeleteModal'));

  probeDeleteButtons.forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation(); // prevent row click selection (if undesired)
      const name = btn.dataset.name || '';
      const url = btn.dataset.url || '';
      const site = btn.dataset.site || '';
      const id = btn.dataset.id || '';

      // Fill modal fields
      document.getElementById('probeDeleteModalLabel').textContent = `Delete Probe: ${name}`;
      deleteProbeButton.dataset.id = id;

      if (deleteModal) {
        deleteModal.show();
      } else {
        console.warn("Bootstrap Modal not available - cannot show delete modal.");
      }
    });
  });

  deleteProbeButton.addEventListener("click", async function() {
    const probeId = deleteProbeButton.dataset.id;
    const probeName = deleteProbeButton.dataset.name;
    if (!probeId) {
      alert("Probe ID not found!");
      return;
    }

    const endpoint = `https://${mntrURL}/v1/api/core/probes/delete?usr={{ cur_usr }}`;
    const payload = { id: probeId };

    try {
      // Select the spinner element within the button
      const spinner = this.querySelector('.spinner-grow');
      // Select the text element within the button
      const buttonText = this.querySelector('.prb-delete-button-text');

      // Show the spinner and hide the text
      spinner.classList.remove('d-none');
      spinner.classList.add('d-inline-block');
      buttonText.textContent = "Deleting...";
      
      // Disable the button
      this.disabled = true;

      const resp = await fetch(endpoint, {method: "POST", credentials:"same-origin", headers: {"Content-Type": "application/json"}, body: JSON.stringify(payload)});
      if (resp.ok) {
        spinner.classList.remove('d-inline-block');
        spinner.classList.add('d-none');
        buttonText.textContent = "Delete";
      
        // Enable the button
        this.disabled = false;

        document.getElementById('notificationModalLabel').textContent = "Probe Deletion Success";

        document.getElementById('notif-modal-text').textContent = `Probe ${probeName} deletion successful!`;

        notificationModal.show();

        if (deleteModal) {
          deleteModal.hide();
        }

      } else {
        spinner.classList.remove('d-inline-block');
        spinner.classList.add('d-none');
        buttonText.textContent = "Delete";

        document.getElementById('notificationModalLabel').textContent = "Probe Deletion Failed";

        document.getElementById('notif-modal-text').textContent = `Probe ${probeName} deletion failed!`;

        notificationModal.show();

        if (deleteModal) {
          deleteModal.hide();
        }
      }
    } catch (err) {
      console.error("Error deleting probe:", err);
    }
  });

  
</script>

{% endblock %}
