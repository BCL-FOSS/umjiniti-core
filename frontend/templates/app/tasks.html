{% extends 'app/base.html' %}

{% block content %}
<style>
  .modal {
    z-index: 2050 !important;
  }
</style>
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-header pb-0">
          <h6>All Tasks</h6>
        </div>
        <div class="card-body px-0 pt-0 pb-2">
          <div class="table-responsive">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Type</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Name</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Enabled</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Site</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Timestamp</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for task in all_tasks.values() %}
                <tr>
                  <td>
                    <div class="d-flex px-2">
                      <div>
                        <img src="{{ url_for('static', filename='img/bcl/task_item.svg') }}" class="avatar avatar-sm rounded-circle me-2"/>
                      </div>
                      <div class="my-auto">
                        <h6 class="mb-0 text-xs">{{ task.task_type }}</h6>
                      </div>
                    </div>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ task.name }}</p>
                  </td>
                  <td>
                    <div class="d-flex px-2">
                      <div>
                        <img src="{{ url_for('static', filename='img/bcl/'+task.enabled+'.svg') }}" class="avatar avatar-sm rounded-circle me-2"/>
                      </div>
                    </div>
                  </td>
                  <td>
                  <td>
                    <span class="badge badge-dot me-4">
                      <i class="bg-info"></i>
                      <span class="text-dark text-xs">{{ task.site }}</span>
                    </span>
                  </td>
                  <td class="align-middle text-center">
                    <div class="d-flex align-items-center">
                      <span class="me-2 text-xs">{{ task.timestamp }}</span>
                    </div>
                  </td>

                  <td class="align-middle">
                    <div class="input-group mb-3">
                      <button type="button" class="btn btn-sm btn-info ms-2 task-toggle-btn"
                          data-name="{{ task.name|e }}"
                          data-site="{{ task.site|e }}"
                          data-prb_id="{{ task.prb_id|e }}"
                          data-timestamp="{{ task.timestamp|e }}"
                          data-task_type="{{ task.task_type|e }}"
                          data-id="{{ task.id }}"
                          data-enabled="{{ task.enabled|e }}"
                          data-comment="{{ task.comment|e }}">
                        Enable/Disable
                      </button>
                      <button type="button" class="btn btn-sm btn-info ms-2 task-reschedule-btn"
                          data-name="{{ task.name|e }}"
                          data-site="{{ task.site|e }}"
                          data-prb_id="{{ task.prb_id|e }}"
                          data-timestamp="{{ task.timestamp|e }}"
                          data-task_type="{{ task.task_type|e }}"
                          data-id="{{ task.id }}"
                          data-enabled="{{ task.enabled|e }}"
                          data-comment="{{ task.comment|e }}">
                        Reschedule
                      </button>
                      <button type="button" class="btn btn-sm btn-info ms-2 task-delete-btn"
                          data-name="{{ task.name|e }}"
                          data-site="{{ task.site|e }}"
                          data-prb_id="{{ task.prb_id|e }}"
                          data-timestamp="{{ task.timestamp|e }}"
                          data-task_type="{{ task.task_type|e }}"
                          data-id="{{ task.id }}"
                          data-enabled="{{ task.enabled|e }}"
                          data-comment="{{ task.comment|e }}">
                        Delete
                      </button>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="taskToggleModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="taskToggleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="taskToggleModalLabel">Toggle Task</h5>
        <div id="task-toggle-id-holder"></div>
        <div id="task-toggle-comment-holder"></div>
        <div id="task-toggle-enabled-holder"></div>
        <div id="task-toggle-name-holder"></div>
        <div id="task-toggle-type-holder"></div>
        <div id="task-toggle-site-holder"></div>
        <div id="task-toggle-timestamp-holder"></div>
        <div id="task-toggle-prb_id-holder"></div>
       
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="task-toggle-msg"></p>
      
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="task-toggle-init">Enable/Disable</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="taskRescheduleModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="taskRescheduleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="taskRescheduleModalLabel">Reschedule Task</h5>
        <div id="task-reschedule-id-holder"></div>
        <div id="task-reschedule-comment-holder"></div>
        <div id="task-reschedule-enabled-holder"></div>
        <div id="task-reschedule-name-holder"></div>
        <div id="task-reschedule-type-holder"></div>
        <div id="task-reschedule-site-holder"></div>
        <div id="task-reschedule-timestamp-holder"></div>
        <div id="task-reschedule-prb_id-holder"></div>
       
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="POST">
          <div class="form-floating mb-3">
            <h6 class="form-label bold">Task Schedule Settings</h6>
            <div class="row mb-3">
              <div class="col-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" role="switch" id="llmAnalysisSwitch">
                  <label class="form-check-label" for="llmAnalysisSwitch">Enable LLM Analysis</label>
                </div>
              </div>
              <div class="col-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" role="switch" id="automationSwitch">
                  <label class="form-check-label" for="automationSwitch">Enable Agent Automation</label>
                </div>
              </div>
            </div>
          </div>
          <div class="form-floating mb-3">
            <h6 class="form-label bold">Task Run Schedule</h6>
            <p class="form-text">Use the fields below to set up a custom schedule for the selected task. Enter times ascomma-separated values or ranges.</p>
            <div class="row mb-3">
                <div class="col-12">
                  <label class="form-label">Choose day(s) of week to run task. Available values: 0 (Sunday) to 6 (Saturday).</label>
                  <input class="form-control" type="text" id="task-days">
                  <div class="form-text">To run every Sunday, Wednesday and Saturday enter as such: 0,3,6.</div>
                </div>
            </div>
            <div class="row mb-3">
              <div class="col-12">
                  <label class="form-label">Choose minute(s) to run task. Available values: 0 to 59.</label>
                  <input class="form-control" type="text" id="task-minutes">
                  <div class="form-text">For specific intervals, enter start,end,interval (e.g., 5,50,5). The task would run every 5 minutes from 5 to 50. </div> 
                </div>
            </div>
            <div class="row mb-3">
              <div class="col-12">
                  <label class="form-label">Choose day(s) of month to run task. Available values: 1 to 31.</label>
                  <input class="form-control" type="text" id="task-dom">
                  <div class="form-text">For specific intervals, enter start,end,interval (e.g., 1,31,1). The task would run every day from 1 to 31. </div> 
                </div>
            </div>
            <div class="row mb-3">
              <div class="col-12">
                  <label class="form-label">Choose month(s) to run task. Available values: 1 to 12.</label>
                  <input class="form-control" type="text" id="task-months">
                  <div class="form-text">For specific intervals, enter start,end,interval (e.g., 1,12,1). The task would run every month from January to December. </div> 
                </div>
            </div>
            <div class="row mb-3">
              <div class="col-12">
                  <label class="form-label">Choose hour(s) to run task. Available values: 0 to 23.</label>
                  <input class="form-control" type="text" id="task-hours">
                  <div class="form-text">For specific intervals, enter start,end,interval (e.g., 0,23,1). The task would run every hour from 0 to 23. </div> 
                </div>  
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="task-reschedule-init">Reschedule</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="taskDeleteModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="taskDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="taskDeleteModalLabel">Delete Task</h5>
        <div id="task-delete-id-holder"></div>
        <div id="task-delete-comment-holder"></div>
        <div id="task-delete-enabled-holder"></div>
        <div id="task-delete-name-holder"></div>
        <div id="task-delete-type-holder"></div>
        <div id="task-delete-site-holder"></div>
        <div id="task-delete-timestamp-holder"></div>
        <div id="task-delete-prb_id-holder"></div>
       
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="task-delete-msg"></p>
      
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="task-delete-init">Resolve</button>
      </div>
    </div>
  </div>
</div>


<script type="text/javascript">
document.addEventListener("DOMContentLoaded", () => {
  const table = document.querySelector("#probeTable");
  const rows = table.querySelectorAll("tbody tr");
  const mntrURL = "{{ mntr_url }}";
  const notificationModal = new bootstrap.Modal(document.getElementById('notificationModal'), {});

  // Handle row selection
  rows.forEach(row => {
    row.addEventListener("click", () => {
      rows.forEach(r => {
        r.classList.remove("selected");
        r.style.backgroundColor = "";
      });
      row.classList.add("selected");
      row.style.backgroundColor = "lightcoral";
    });
  });

  // Alert action buttons
  const taskToggleButtons = document.querySelectorAll(".task-toggle-btn");
  const taskRescheduleButtons = document.querySelectorAll(".task-reschedule-btn");
  const taskDeleteButtons = document.querySelectorAll(".task-delete-btn");

  // Alert Modals
  const taskToggleModalEl = document.getElementById('taskToggleModal');
  let taskToggleModal = null;
  if (taskToggleModalEl) {
    taskToggleModal = new bootstrap.Modal(taskToggleModalEl, {});
  } 

  const taskRescheduleModalEl = document.getElementById('taskRescheduleModal');
  let taskRescheduleModal = null;
  if (taskRescheduleModalEl) {
    taskRescheduleModal = new bootstrap.Modal(taskRescheduleModalEl, {});
  }

  const taskDeleteModalEl = document.getElementById('taskDeleteModal');
  let taskDeleteModal = null;
  if (taskDeleteModalEl) {
    taskDeleteModal = new bootstrap.Modal(taskDeleteModalEl, {});
  }

  // View Details button handler

  taskToggleButtons.forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation(); // prevent row click selection (if undesired)
      const name = btn.dataset.name || '';
      const site = btn.dataset.site || '';
      const prb_id = btn.dataset.prb_id || '';
      const timestamp = btn.dataset.timestamp || '';
      const task_type = btn.dataset.task_type || '';
      const enabled = btn.dataset.enabled || '';
      const comment = btn.dataset.comment || '';
      const id = btn.dataset.id || '';
      // Fill modal fields
      document.getElementById('taskToggleModalLabel').textContent = `Toggle Task - ${name} ${task_type}`;
      document.getElementById('task-toggle-msg').textContent = `Are you sure you want to toggle the task: ${name} currently set to ${enabled}`;
      document.getElementById('task-toggle-id-holder').dataset.id = id;
      document.getElementById('task-toggle-comment-holder').dataset.comment = comment;
      document.getElementById('task-toggle-enabled-holder').dataset.enabled = enabled;
      document.getElementById('task-toggle-name-holder').dataset.name = name;
      document.getElementById('task-toggle-type-holder').dataset.type = task_type;
      document.getElementById('task-toggle-site-holder').dataset.site = site;
      document.getElementById('task-toggle-timestamp-holder').dataset.timestamp = timestamp;
      document.getElementById('task-toggle-prb_id-holder').dataset.prb_id = prb_id;
      if (taskToggleModal) {
        taskToggleModal.show();
      } else {
        console.warn("Bootstrap Modal not available - cannot show task toggle modal.");
      }
    });
  });

  taskRescheduleButtons.forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation(); // prevent row click selection (if undesired)
      const name = btn.dataset.name || '';
      const site = btn.dataset.site || '';
      const prb_id = btn.dataset.prb_id || '';
      const timestamp = btn.dataset.timestamp || '';
      const task_type = btn.dataset.task_type || '';
      const enabled = btn.dataset.enabled || '';
      const comment = btn.dataset.comment || '';
      const id = btn.dataset.id || '';
      // Fill modal fields
      document.getElementById('taskRescheduleModalLabel').textContent = `Reschedule Task - ${name} ${task_type}`;
      document.getElementById('task-reschedule-id-holder').dataset.id = id;
      document.getElementById('task-reschedule-comment-holder').dataset.comment = comment;
      document.getElementById('task-reschedule-enabled-holder').dataset.enabled = enabled;
      document.getElementById('task-reschedule-name-holder').dataset.name = name;
      document.getElementById('task-reschedule-type-holder').dataset.type = task_type;
      document.getElementById('task-reschedule-site-holder').dataset.site = site;
      document.getElementById('task-reschedule-timestamp-holder').dataset.timestamp = timestamp;
      document.getElementById('task-reschedule-prb_id-holder').dataset.prb_id = prb_id;
      // You can also fill in the current schedule settings if needed
      if (taskRescheduleModal) {
        taskRescheduleModal.show();
      } else {
        console.warn("Bootstrap Modal not available - cannot show task reschedule modal.");
      }
    });
  }); 

  taskDeleteButtons.forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation(); // prevent row click selection (if undesired)
      const name = btn.dataset.name || '';
      const site = btn.dataset.site || '';
      const prb_id = btn.dataset.prb_id || '';
      const timestamp = btn.dataset.timestamp || '';
      const task_type = btn.dataset.task_type || '';
      const enabled = btn.dataset.enabled || '';
      const comment = btn.dataset.comment || '';
      const id = btn.dataset.id || '';
      // Fill modal fields
      document.getElementById('taskDeleteModalLabel').textContent = `Delete Task - ${name} ${task_type}`;
      document.getElementById('task-delete-msg').textContent = `Are you sure you want to delete the task: ${name} currently set to ${enabled}`;
      document.getElementById('task-delete-id-holder').dataset.id = id;
      document.getElementById('task-delete-comment-holder').dataset.comment = comment;
      document.getElementById('task-delete-enabled-holder').dataset.enabled = enabled;
      document.getElementById('task-delete-name-holder').dataset.name = name;
      document.getElementById('task-delete-type-holder').dataset.type = task_type;
      document.getElementById('task-delete-site-holder').dataset.site = site;
      document.getElementById('task-delete-timestamp-holder').dataset.timestamp = timestamp;
      document.getElementById('task-delete-prb_id-holder').dataset.prb_id = prb_id;
      if (taskDeleteModal) {
        taskDeleteModal.show();
      } else {
        console.warn("Bootstrap Modal not available - cannot show task delete modal.");
      }
    });
  }); 

});
</script>
{% endblock %}